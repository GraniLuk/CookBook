{{ define "main" }}
<div class="page-section recipe-page">
    <div class="recipe-page-container">
        <div class="recipe-card">
            <div class="flex recipe-hero-wrap" style="justify-content: center; position: relative;">
                <div class="recipe-status-icons">
                    {{ if .Params.favourite }}
                    <span class="inline-flex items-center text-2xl text-warning">
                        <i class="fas fa-star"></i>
                    </span>
                    {{ end }}
                    {{ if .Params.queued }}
                    <span class="inline-flex items-center text-2xl">
                        <i class="fas fa-hourglass"></i>
                    </span>
                    {{ end }}
                </div>
                <figure class="recipe-hero">
                    {{- $image_url := partial "asset-url.html" "/images/defaultImage.avif" -}}
                    {{- if and .Params.recipe_image (fileExists (printf "static/%s" .Params.recipe_image)) -}}
                    {{- $image_url = partial "asset-url.html" (printf "/%s" .Params.recipe_image) -}}
                    {{- end -}}
                    <img src="{{ $image_url }}" alt="Recipe image">
                    <div class="recipe-hero__gradient" aria-hidden="true"></div>
                    <div class="recipe-hero__title">
                        <h1 class="text-3xl font-serif font-bold text-white">{{ .Title }}</h1>
                        <div class="fodmap-indicator">
                            <div style="margin-top:.5rem;">{{ partial "fodmap-badge.html" . }}</div>
                        </div>
                    </div>
                    {{- $videoFileHref := "" -}}
                    {{- with .Params.video_file -}}
                    {{- $videoFileHref = partial "asset-url.html" (printf "/%s" .) -}}
                    {{- end -}}
                    {{- $videoFileHref2 := "" -}}
                    {{- with .Params.video_file2 -}}
                    {{- $videoFileHref2 = partial "asset-url.html" (printf "/%s" .) -}}
                    {{- end -}}
                    {{- $youtubeHref := "" -}}
                    {{- with .Params.link -}}
                    {{- $youtubeHref = . -}}
                    {{- end -}}
                    {{- $modalId := printf "recipe-video-modal-%s" (anchorize .Title) -}}
                    {{- $modalId2 := printf "recipe-video-modal-%s-2" (anchorize .Title) -}}
                    {{ if or $youtubeHref $videoFileHref $videoFileHref2 }}
                    <div id="mediaButtons" class="rounded-full media-badge media-badge--left">
                        {{ if $youtubeHref }}
                        <a href="{{ $youtubeHref }}" target="_blank" rel="noopener"
                            aria-label="Otwórz wideo na YouTube">
                            <i class="fab fa-youtube" aria-hidden="true"></i>
                        </a>
                        {{ end }}
                        {{ if $videoFileHref }}
                        <button type="button" class="unstyled-btn" aria-label="Odtwórz lokalne wideo"
                            data-video-modal-trigger="{{ $modalId }}">
                            <i class="fas fa-film" aria-hidden="true"></i>
                        </button>
                        {{ end }}
                        {{ if $videoFileHref2 }}
                        <button type="button" class="unstyled-btn" aria-label="Odtwórz lokalne wideo 2"
                            data-video-modal-trigger="{{ $modalId2 }}">
                            <i class="fas fa-film" aria-hidden="true"></i>
                        </button>
                        {{ end }}
                    </div>
                    {{ end }}
                    <div id="shareButton" class="rounded-full media-badge media-badge--right">
                        {{- $collection := "sniadania" -}}
                        {{- /* Prefer explicit param or page section: queued */ -}}
                        {{- if or .Params.queued (eq .Section "queued") -}}
                        {{- $collection = "queued" -}}
                        {{- end -}}
                        {{- $filePath := replace .File.Path "\\" "/" -}}
                        {{- if and (ne $collection "queued") (or (strings.Contains $filePath "content/queued/") (strings.Contains $filePath "/queued/")) -}}
                        {{- $collection = "queued" -}}
                        {{- else if or (strings.Contains $filePath "published/obiady/") (strings.Contains $filePath
                        "/obiady/") -}}
                        {{- $collection = "obiady" -}}
                        {{- else if or (strings.Contains $filePath "published/sniadania/") (strings.Contains $filePath
                        "/sniadania/") -}}
                        {{- $collection = "sniadania" -}}
                        {{- else if or (strings.Contains $filePath "published/kolacje/") (strings.Contains $filePath
                        "/kolacje/") -}}
                        {{- $collection = "kolacje" -}}
                        {{- else if or (strings.Contains $filePath "published/desery/") (strings.Contains $filePath
                        "/desery/") -}}
                        {{- $collection = "desery" -}}
                        {{- else if or (strings.Contains $filePath "published/przekaski/") (strings.Contains $filePath
                        "/przekaski/") -}}
                        {{- $collection = "przekaski" -}}
                        {{- else if or (strings.Contains $filePath "published/salatki/") (strings.Contains $filePath
                        "/salatki/") -}}
                        {{- $collection = "salatki" -}}
                        {{- else if or (strings.Contains $filePath "published/napoje/") (strings.Contains $filePath
                        "/napoje/") -}}
                        {{- $collection = "napoje" -}}
                        {{- else if or (strings.Contains $filePath "published/sosy/") (strings.Contains $filePath
                        "/sosy/") -}}
                        {{- $collection = "sosy" -}}
                        {{- end -}}
                        {{- $encodedEntry := urlquery .File.ContentBaseName -}}
                        {{- $encodedEntry = replace $encodedEntry "+" "%20" -}}
                        {{- $encodedEntry = replace $encodedEntry "%2C" "," -}}
                        {{- $editPath := printf "admin/#/collections/%s/entries/%s" $collection $encodedEntry -}}
                        <a href="{{ absURL $editPath }}"
                            target="_blank" rel="noopener" aria-label="Edit recipe" class="unstyled-btn">
                            <i class="fas fa-pen-to-square" aria-hidden="true"></i>
                        </a>
                        <button onclick="shareRecipe()" aria-label="Share recipe" class="unstyled-btn">
                            <i class="fas fa-share-from-square" aria-hidden="true"></i>
                        </button>
                    </div>
                    {{/* Rating stars section */}}
                    <div class="rating-section">
                        {{ partial "rating.html" . }}
                    </div>
                </figure>
            </div>

            {{ if $videoFileHref }}
            <dialog id="{{ $modalId }}" class="modal recipe-video-modal" aria-label="Odtwarzacz wideo">
                <div class="modal-box max-w-4xl p-0 bg-black">
                    <form method="dialog">
                        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 text-white z-10" aria-label="Zamknij wideo">
                            <i class="fas fa-times"></i>
                        </button>
                    </form>
                    <video class="recipe-video-modal__player w-full" controls preload="metadata" data-video-modal-player>
                        <source src="{{ $videoFileHref }}" type="video/mp4">
                        Twoja przeglądarka nie wspiera odtwarzania wideo. Pobierz plik
                        <a href="{{ $videoFileHref }}">tutaj</a>.
                    </video>
                </div>
                <form method="dialog" class="modal-backdrop">
                    <button aria-label="Zamknij">close</button>
                </form>
            </dialog>
            {{ end }}

            {{ if $videoFileHref2 }}
            <dialog id="{{ $modalId2 }}" class="modal recipe-video-modal" aria-label="Odtwarzacz wideo 2">
                <div class="modal-box max-w-4xl p-0 bg-black">
                    <form method="dialog">
                        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 text-white z-10" aria-label="Zamknij wideo">
                            <i class="fas fa-times"></i>
                        </button>
                    </form>
                    <video class="recipe-video-modal__player w-full" controls preload="metadata" data-video-modal-player>
                        <source src="{{ $videoFileHref2 }}" type="video/mp4">
                        Twoja przeglądarka nie wspiera odtwarzania wideo. Pobierz plik
                        <a href="{{ $videoFileHref2 }}">tutaj</a>.
                    </video>
                </div>
                <form method="dialog" class="modal-backdrop">
                    <button aria-label="Zamknij">close</button>
                </form>
            </dialog>
            {{ end }}



            <div class="text-center recipe-meta recipe-meta--stats">
                {{ partial "statstable.html" . }}
            </div>
            <hr class="recipe-sep">
            <div class="text-center recipe-meta recipe-meta--macros">
                {{ partial "macrostable.html" . }}
            </div>
            <hr>
            <p class="text-lg text-gray-600 italic"> {{ .Params.Tagline }}</p>
            <div class="content">
                {{ .Content }}
            </div>
            {{/* FODMAP panel placed after content (below nutrition tables which precede .Content) */}}
            <div class="fodmap-indicator">
                {{ partial "fodmap-panel.html" . }}
            </div>
        </div>
    </div>
</div>
{{ end }}