{{ define "main" }}
<div class="section recipe-page">
    <div class="columns is-centered">
        <div class="column is-full-mobile is-8-desktop recipe-card">
            <div class="is-flex recipe-hero-wrap" style="justify-content: center; position: relative;">
                <div class="recipe-status-icons">
                    {{ if .Params.favourite }}
                    <span class="icon is-large has-text-warning">
                        <i class="fas fa-star"></i>
                    </span>
                    {{ end }}
                    {{ if .Params.queued }}
                    <span class="icon is-large">
                        <i class="fas fa-hourglass"></i>
                    </span>
                    {{ end }}
                </div>
                <figure class="image recipe-hero">
                    {{- $image_url := partial "asset-url.html" "/images/defaultImage.avif" -}}
                    {{- if and .Params.recipe_image (fileExists (printf "static/%s" .Params.recipe_image)) -}}
                    {{- $image_url = partial "asset-url.html" (printf "/%s" .Params.recipe_image) -}}
                    {{- end -}}
                    <img src="{{ $image_url }}" alt="Recipe image">
                    <div class="recipe-hero__gradient" aria-hidden="true"></div>
                    <div class="recipe-hero__title">
                        <h1 class="title is-bold has-text-white">{{ .Title }}</h1>
                        <div class="fodmap-indicator">
                            <div style="margin-top:.5rem;">{{ partial "fodmap-badge.html" . }}</div>
                        </div>
                    </div>
                    {{- $videoFileHref := "" -}}
                    {{- with .Params.video_file -}}
                    {{- $videoFileHref = partial "asset-url.html" (printf "/%s" .) -}}
                    {{- end -}}
                    {{- $videoFileHref2 := "" -}}
                    {{- with .Params.video_file2 -}}
                    {{- $videoFileHref2 = partial "asset-url.html" (printf "/%s" .) -}}
                    {{- end -}}
                    {{- $youtubeHref := "" -}}
                    {{- with .Params.link -}}
                    {{- $youtubeHref = . -}}
                    {{- end -}}
                    {{- $modalId := printf "recipe-video-modal-%s" (anchorize .Title) -}}
                    {{- $modalId2 := printf "recipe-video-modal-%s-2" (anchorize .Title) -}}
                    {{ if or $youtubeHref $videoFileHref $videoFileHref2 }}
                    <div id="mediaButtons" class="is-rounded media-badge media-badge--left">
                        {{ if $youtubeHref }}
                        <a href="{{ $youtubeHref }}" target="_blank" rel="noopener"
                            aria-label="Otwórz wideo na YouTube">
                            <i class="fab fa-youtube" aria-hidden="true"></i>
                        </a>
                        {{ end }}
                        {{ if $videoFileHref }}
                        <button type="button" class="unstyled-btn" aria-label="Odtwórz lokalne wideo"
                            data-video-modal-trigger="{{ $modalId }}">
                            <i class="fas fa-film" aria-hidden="true"></i>
                        </button>
                        {{ end }}
                        {{ if $videoFileHref2 }}
                        <button type="button" class="unstyled-btn" aria-label="Odtwórz lokalne wideo 2"
                            data-video-modal-trigger="{{ $modalId2 }}">
                            <i class="fas fa-film" aria-hidden="true"></i>
                        </button>
                        {{ end }}
                    </div>
                    {{ end }}
                    <div id="shareButton" class="is-rounded media-badge media-badge--right">
                        {{- $collection := "sniadania" -}}
                        {{- /* Prefer explicit param or page section: queued */ -}}
                        {{- if or .Params.queued (eq .Section "queued") -}}
                        {{- $collection = "queued" -}}
                        {{- end -}}
                        {{- $filePath := replace .File.Path "\\" "/" -}}
                        {{- if and (ne $collection "queued") (or (strings.Contains $filePath "content/queued/") (strings.Contains $filePath "/queued/")) -}}
                        {{- $collection = "queued" -}}
                        {{- else if or (strings.Contains $filePath "published/obiady/") (strings.Contains $filePath
                        "/obiady/") -}}
                        {{- $collection = "obiady" -}}
                        {{- else if or (strings.Contains $filePath "published/sniadania/") (strings.Contains $filePath
                        "/sniadania/") -}}
                        {{- $collection = "sniadania" -}}
                        {{- else if or (strings.Contains $filePath "published/kolacje/") (strings.Contains $filePath
                        "/kolacje/") -}}
                        {{- $collection = "kolacje" -}}
                        {{- else if or (strings.Contains $filePath "published/desery/") (strings.Contains $filePath
                        "/desery/") -}}
                        {{- $collection = "desery" -}}
                        {{- else if or (strings.Contains $filePath "published/przekaski/") (strings.Contains $filePath
                        "/przekaski/") -}}
                        {{- $collection = "przekaski" -}}
                        {{- else if or (strings.Contains $filePath "published/salatki/") (strings.Contains $filePath
                        "/salatki/") -}}
                        {{- $collection = "salatki" -}}
                        {{- else if or (strings.Contains $filePath "published/napoje/") (strings.Contains $filePath
                        "/napoje/") -}}
                        {{- $collection = "napoje" -}}
                        {{- else if or (strings.Contains $filePath "published/sosy/") (strings.Contains $filePath
                        "/sosy/") -}}
                        {{- $collection = "sosy" -}}
                        {{- end -}}
                        {{- $encodedEntry := urlquery .File.ContentBaseName -}}
                        {{- $encodedEntry = replace $encodedEntry "+" "%20" -}}
                        {{- $encodedEntry = replace $encodedEntry "%2C" "," -}}
                        {{- $editPath := printf "admin/#/collections/%s/entries/%s" $collection $encodedEntry -}}
                        <a href="{{ absURL $editPath }}"
                            target="_blank" rel="noopener" aria-label="Edit recipe" class="unstyled-btn">
                            <i class="fas fa-pen-to-square" aria-hidden="true"></i>
                        </a>
                        <button onclick="shareRecipe()" aria-label="Share recipe" class="unstyled-btn">
                            <i class="fas fa-share-from-square" aria-hidden="true"></i>
                        </button>
                    </div>
                </figure>
            </div>

            {{ if $videoFileHref }}
            <div id="{{ $modalId }}" class="modal recipe-video-modal" role="dialog" aria-modal="true"
                aria-label="Odtwarzacz wideo" tabindex="-1">
                <div class="modal-background" data-video-modal-close></div>
                <div class="modal-content">
                    <div class="box recipe-video-modal__box">
                        <video class="recipe-video-modal__player" controls preload="metadata" data-video-modal-player>
                            <source src="{{ $videoFileHref }}" type="video/mp4">
                            Twoja przeglądarka nie wspiera odtwarzania wideo. Pobierz plik
                            <a href="{{ $videoFileHref }}">tutaj</a>.
                        </video>
                    </div>
                </div>
                <button class="modal-close is-large" aria-label="Zamknij wideo" data-video-modal-close></button>
            </div>
            {{ end }}

            {{ if $videoFileHref2 }}
            <div id="{{ $modalId2 }}" class="modal recipe-video-modal" role="dialog" aria-modal="true"
                aria-label="Odtwarzacz wideo 2" tabindex="-1">
                <div class="modal-background" data-video-modal-close></div>
                <div class="modal-content">
                    <div class="box recipe-video-modal__box">
                        <video class="recipe-video-modal__player" controls preload="metadata" data-video-modal-player>
                            <source src="{{ $videoFileHref2 }}" type="video/mp4">
                            Twoja przeglądarka nie wspiera odtwarzania wideo. Pobierz plik
                            <a href="{{ $videoFileHref2 }}">tutaj</a>.
                        </video>
                    </div>
                </div>
                <button class="modal-close is-large" aria-label="Zamknij wideo 2" data-video-modal-close></button>
            </div>
            {{ end }}

            {{/* Shopping List - Add Ingredients Button */}}
            {{ if .Params.ingredients }}
            <div class="shopping-list-add-section">
                <button class="button is-success is-medium shopping-add-btn" id="openIngredientModal" aria-label="Dodaj składniki do listy zakupów">
                    <span class="icon"><i class="fas fa-cart-plus"></i></span>
                    <span>Dodaj do listy</span>
                </button>
            </div>

            <!-- Ingredient Selection Modal -->
            <div class="modal" id="ingredientModal" role="dialog" aria-modal="true" aria-labelledby="ingredientModalTitle">
                <div class="modal-background" data-close-ingredient-modal></div>
                <div class="modal-card">
                    <header class="modal-card-head">
                        <p class="modal-card-title" id="ingredientModalTitle">Dodaj składniki do listy</p>
                        <button class="delete" aria-label="Zamknij" data-close-ingredient-modal></button>
                    </header>
                    <section class="modal-card-body">
                        <div class="ingredient-modal-actions">
                            <button class="button is-small" id="selectAllIngredients">Zaznacz wszystko</button>
                            <button class="button is-small" id="selectNoneIngredients">Odznacz wszystko</button>
                        </div>
                        <ul class="ingredient-select-list" id="ingredientSelectList">
                            {{- range $index, $ingredient := .Params.ingredients -}}
                            <li class="ingredient-select-item">
                                <label class="ingredient-select-label">
                                    <input type="checkbox" class="ingredient-checkbox" value="{{ $ingredient }}" checked>
                                    <span class="ingredient-checkmark"><i class="fas fa-check"></i></span>
                                    <span class="ingredient-name">{{ $ingredient }}</span>
                                </label>
                            </li>
                            {{- end -}}
                        </ul>
                    </section>
                    <footer class="modal-card-foot">
                        <button class="button is-success" id="addSelectedIngredients">
                            <span class="icon"><i class="fas fa-plus"></i></span>
                            <span>Dodaj wybrane</span>
                        </button>
                        <button class="button" data-close-ingredient-modal>Anuluj</button>
                    </footer>
                </div>
            </div>

            <script>
            (function() {
                const modal = document.getElementById('ingredientModal');
                const openBtn = document.getElementById('openIngredientModal');
                const closeElements = document.querySelectorAll('[data-close-ingredient-modal]');
                const selectAllBtn = document.getElementById('selectAllIngredients');
                const selectNoneBtn = document.getElementById('selectNoneIngredients');
                const addBtn = document.getElementById('addSelectedIngredients');
                const checkboxes = document.querySelectorAll('.ingredient-checkbox');
                const recipeTitle = {{ .Title | jsonify }};

                // Open modal
                openBtn.addEventListener('click', () => {
                    modal.classList.add('is-active');
                    document.documentElement.classList.add('is-clipped');
                });

                // Close modal
                closeElements.forEach(el => {
                    el.addEventListener('click', closeModal);
                });

                function closeModal() {
                    modal.classList.remove('is-active');
                    document.documentElement.classList.remove('is-clipped');
                }

                // Select all
                selectAllBtn.addEventListener('click', () => {
                    checkboxes.forEach(cb => cb.checked = true);
                });

                // Select none
                selectNoneBtn.addEventListener('click', () => {
                    checkboxes.forEach(cb => cb.checked = false);
                });

                // Add selected ingredients
                addBtn.addEventListener('click', () => {
                    const selected = [];
                    checkboxes.forEach(cb => {
                        if (cb.checked) {
                            selected.push(cb.value);
                        }
                    });

                    if (selected.length === 0) {
                        alert('Wybierz przynajmniej jeden składnik.');
                        return;
                    }

                    // Store in localStorage for CMS to pick up
                    let pending = [];
                    try {
                        pending = JSON.parse(localStorage.getItem('cookbook-shopping-pending') || '[]');
                    } catch(e) {}

                    selected.forEach(name => {
                        if (!pending.find(i => i.name === name && i.source === recipeTitle)) {
                            pending.push({ name: name, quantity: '', source: recipeTitle });
                        }
                    });

                    localStorage.setItem('cookbook-shopping-pending', JSON.stringify(pending));

                    // Show confirmation and offer to go to CMS
                    const count = selected.length;
                    
                    // Store in localStorage
                    localStorage.setItem('cookbook-shopping-pending', JSON.stringify(pending));

                    closeModal();

                    // Show confirmation
                    const msg = `✅ Wybrano ${count} składnik${count === 1 ? '' : count < 5 ? 'i' : 'ów'}.\n\nOtworzyć CMS? Zobaczysz panel z listą składników do dodania.`;
                    
                    if (confirm(msg)) {
                        window.open('/CookBook/admin/#/collections/shopping_list/entries/shopping_list', '_blank');
                    }
                });

                // Close on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && modal.classList.contains('is-active')) {
                        closeModal();
                    }
                });
            })();
            </script>
            {{ end }}

            <div class="container has-text-centered recipe-meta recipe-meta--stats">
                {{ partial "statstable.html" . }}
            </div>
            </div>
            <hr class="recipe-sep">
            <div class="container has-text-centered recipe-meta recipe-meta--macros">
                {{ partial "macrostable.html" . }}
            </div>
            <hr>
            <p class="subtitle is-italic"> {{ .Params.Tagline }}</p>
            <div class="content">
                {{ .Content }}
            </div>
            {{/* FODMAP panel placed after content (below nutrition tables which precede .Content) */}}
            <div class="fodmap-indicator">
                {{ partial "fodmap-panel.html" . }}
            </div>
        </div>
    </div>
</div>
{{ end }}